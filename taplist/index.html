<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="author" content="Andrew Clow, from original code by Phil Murray">
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />

    <title>RCC Tap List</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">
    <link href="taplist.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
  </head>

  <body onload="startTime()">

    <div class="container">

      <div class="box header">
        <div class="logo"></div>
          <div class="title">
            <h1 id="title">Loading...</h1>
          </div>
        <div id="clock" class="clock"></div>
      </div>

      <div id="taps" class="box taplist">

      </div>
    </div>
    <div class="box cardKey" id="cardDetails"><!-- ...card message placeholder... --></div>
    <div class="box footer" id="footer"><marquee><span><!-- ...placeholder, this should replace with message text... --></span></marquee></div>

    <script type="text/javascript">
      var sheetUrl = "https://docs.google.com/spreadsheets/d/1Zr9JT4QnnwZU9PuBM0S4lJQzfayxDLxEh1CoPzV4194/pubhtml";
      var tabletop;

      function init() {
        tabletop = Tabletop.init( {
          key: sheetUrl,
          callback: displayTaps,
          simpleSheet: false
        })
      }

      function headerFooter(data, tabletop) {
        var footerMessage = '';
        var footerItems = 0;
        var sheet = data['Messages'];
        var message = sheet.elements[0]; // Row 2
        if ( message['Title'] == '' ) { // No title defined
          message['Title'] = 'Tap List';
        }
        if (document.getElementById("title").innerHTML !== message['Title']) {
          document.getElementById("title").innerHTML = message['Title'];
        }

        if ( sheet.elements.length == 1 ) {
          document.getElementById("cardDetails").innerHTML = '';
          footerMessage = '<span>'+message['Footer']+'</span>';
        }else{

          message = sheet.elements[1]; // Row 3
          if ( message['Title'] == '' ) { // No card details entered below the title
            document.getElementById("cardDetails").innerHTML = '';
          }else{
            document.getElementById("cardDetails").innerHTML = '<img src="card.png" class="cardDetailsImage"/>' + message['Title'];
          }

          for (var i = 0; i < sheet.elements.length; i++) {
            message = sheet.elements[i]
            if (footerMessage == '') {
              footerItems++;
              footerMessage = '<span>'+message['Footer']+'</span>';
            }else if ( message['Footer'] ) {
              footerItems++;
              footerMessage = footerMessage + '<span>'+message['Footer']+'</span>';
            }
          }
          if ( footerItems > 1 ) {
            footerMessage = '<marquee>' + footerMessage + '</marquee>';
          }
        }
        if (document.getElementById("footer").innerHTML !== footerMessage) {
          document.getElementById("footer").innerHTML = footerMessage;
        }
      }

      function displayTaps(data, tabletop) {
        var beerList = { beers: [] };
        var sheet = data['Taplist'];
        var showJug = false;
        for(var idx = 0; idx < 12; idx++ ) {
          var tap = sheet.elements[idx];
          if(tap['Name'] == '') { // Tap with no beer assigned
            tap['Name'] = '\xa0'; // Non-Breaking Space, ensures row heights match up
          }

          if(tap['Brewery'] != '') {
            tap['Brewery'] = ' - ' + tap['Brewery'];
          }

          let field = 'ABV'
          let abv = parseFloat(tap[field])
          if(!isNaN(abv)) {
            tap[field] = sprintf("%0.1f", abv) + '%';
          } else if(tap[field] == '') {
            tap[field] = '-';
          }

          field = 'half-price'
          let price = parseFloat(tap[field])
          if(!isNaN(price)) {
            tap[field] = "$" + sprintf("%0.2f", price);
          } else if(tap[field] == '') {
            tap[field] = '-';
          }

          field = 'handle-price'
          price = parseFloat(tap[field])
          if(!isNaN(price)) {
            tap[field] = "$" + sprintf("%0.2f", price);
          } else if(tap[field] == '') {
            tap[field] = '-';
          }

          field = 'jug-price'
          price = parseFloat(tap[field])
          if(!isNaN(price)) {
            tap[field] = "$" + sprintf("%0.2f", price);
            showJug = true;
          } else if(tap[field] == '') {
            tap[field] = '-';
          }

          beerList.beers.push(tap);
        }

        if ( showJug ) {
          var templateHtml = document.getElementById('tap-template').innerHTML;
          document.getElementById("taps").className = "box taplist";
        } else {
          document.getElementById("taps").className = "box taplistNoJug";
          var templateHtml = document.getElementById('tap-template-noJug').innerHTML;
        }

        var renderedList  = Mustache.render(templateHtml, beerList);

        document.getElementById("taps").innerHTML = renderedList;

        headerFooter(data,tabletop);
      }

      function startTime(){
        var time = new Date()
        var hr = time.getHours()
        var min = time.getMinutes()
        var sec = time.getSeconds()
        var ampm = " pm "
        if (hr < 12){
          ampm = " am "
        }
        if (hr > 12){
          hr -= 12
        }
        if (hr < 10){
          hr = " " + hr
        }
        if (min < 10){
          min = "0" + min
        }
        if (sec < 10){
          sec = "0" + sec
        }
        document.getElementById('clock').innerHTML = hr + ":" + min + ampm
        setTimeout("startTime()", 1000)
      }

      window.addEventListener("DOMContentLoaded", init);
      // Reload the page every 60 seconds (60000 milliseconds)
      window.setInterval(function() { tabletop.fetch() }, 60000)
    </script>

    <script id="tap-template" type="text/html">
      <div class="labelHeader">
        <div class="labels withJug">
          <div class=""></div>
          <div class="abv">ABV</div>
          <div class="half">Half</div>
          <div class="handle">Handle</div>
          <div class="jug">Jug</div>
        </div>
        <div class="labels withJug">
          <div class=""></div>
          <div class="abv">ABV</div>
          <div class="half">Half</div>
          <div class="handle">Handle</div>
          <div class="jug">Jug</div>
        </div>
      </div>
      <div class="tapContentsWithJug">
        {{#beers}}
        <div class="beersWithJug {{Class}}">
          <div class="badge">
            <img src="{{Badge}}">
          </div>
          <div class="nameWithJug">{{Name}}<span>{{Brewery}}</span></div>
          <div class="beerStyle">{{Style}}</div>
          <div class="values abv">{{ABV}}</div>
          <div class="values half">{{half-price}}</div>
          <div class="values handle">{{handle-price}}</div>
          <div class="values jug">{{jug-price}}</div>
        </div>
        {{/beers}}
      </div>
    </script>

    <script id="tap-template-noJug" type="text/html">
      <div class="labelHeader">
        <div class="labels noJug">
          <div class=""></div>
          <div class="abv">ABV</div>
          <div class="half">Half</div>
          <div class="handle">Handle</div>
        </div>
        <div class="labels noJug">
          <div class=""></div>
          <div class="abv">ABV</div>
          <div class="half">Half</div>
          <div class="handle">Handle</div>
        </div>
      </div>
      <div class="tapContentsNoJug">
        {{#beers}}
        <div class="beersNoJug {{Class}}">
          <div class="badge">
            <img src="{{Badge}}">
          </div>
          <div class="nameNoJug">{{Name}}<span>{{Brewery}}</span></div>
          <div class="beerStyle">{{Style}}</div>
          <div class="values abv">{{ABV}}</div>
          <div class="values half">{{half-price}}</div>
          <div class="values handle">{{handle-price}}</div>
        </div>
        {{/beers}}
      </div>
    </script>

  </body>
</html>

<!-- https://github.com/jsoma/tabletop
https://github.com/jsoma/tabletop/issues/189
https://www.papaparse.com/ -->